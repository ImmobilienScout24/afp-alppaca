#!/usr/bin/env python

### BEGIN INIT INFO
# Provides: alppaca
# Required-Start:
# Required-Stop:
# Default-Start: 2 3 4 5
# Default-Stop: 0 1 6
# Short-Description: Alppaca
# Description: A(mazing)LocalPrefetchProxyforAmazonCredentiAls
### END INIT INFO


import argparse

from succubus import Daemon

from afp_alppaca.main import run_scheduler_and_webserver
from afp_alppaca.util import load_config


class AlppacaDaemon(Daemon):
    def run(self):
        args = self.parse_arguments()
        config = load_config(args.config)

        config['bind_port'] = 4242

        run_scheduler_and_webserver(config)


    def parse_arguments(self):
        parser = argparse.ArgumentParser()
        parser.add_argument(
            '-c', '--config', help="Alppaca YAML config directory", type=str,
            default='/etc/alppaca')

        return parser.parse_args()

if __name__ == "__main__":
    # FIXME: Use proper pid file directory
    alppaca = AlppacaDaemon(pidfile="/tmp/alppaca.pid")
    alppaca.action()
