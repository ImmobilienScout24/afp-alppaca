#!/usr/bin/env python

import argparse
import sys
import os

from succubus import Daemon
from pwd import getpwnam
from grp import getgrnam


from afp_alppaca.main import run_scheduler_and_webserver
from afp_alppaca.util import load_config


class AlppacaDaemon(Daemon):
    def run(self):
        run_scheduler_and_webserver(self.config)

    def parse_arguments(self):
        parser = argparse.ArgumentParser()
        parser.add_argument(
            '-c', '--config', help="Alppaca YAML config directory", type=str,
            default='/etc/alppaca')

        return parser.parse_args()

    def load_configuration(self):
        args = self.parse_arguments()
        self.config = load_config(args.config)


if __name__ == "__main__":
    pidpath = "/var/run/alppacad"
    pidfile = os.path.join(pidpath, "alppacad.pid")
    alppaca = AlppacaDaemon(pid_file=pidfile)
    if not os.path.exists(pidpath):
        os.mkdir(pidpath)
    elif not os.path.isdir(pidpath):
        os.remove(pidpath)
        os.mkdir(pidpath)
    uid = getpwnam(alppaca.user or "root").pw_uid
    gid = getgrnam(alppaca.group or "root").gr_gid
    os.chown(pidpath, uid, gid)

    sys.exit(alppaca.action())
